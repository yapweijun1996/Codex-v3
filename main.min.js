import{openModal,closeModal}from"./js/modal.js";import{debounce,filterTableRows,initPagination}from"./js/table-utils.js";import{initReportChart,initAnalyticsCharts,updateAnalyticsCharts}from"./js/charts.js";const toggle=document.querySelector(".nav-toggle"),sidebar=document.getElementById("sidebar"),overlay=document.getElementById("overlay"),themeToggle=document.querySelector(".theme-toggle"),closeBtn=document.getElementById("sidebar-close"),pageLoader=document.getElementById("page-loader"),firstLink=sidebar?sidebar.querySelector("a"):null;let initialLoad=!0;const tableSkeleton=document.querySelector(".table__skeleton"),userTable=document.getElementById("user-table"),filterInput=document.getElementById("user-filter"),addUserBtn=document.getElementById("add-user-btn"),form=document.getElementById("settings-form"),profileForm=document.getElementById("profile-form"),toast=document.getElementById("toast"),chartCanvas=document.getElementById("reportChart"),taskForm=document.getElementById("task-form"),taskInput=document.getElementById("task-input"),taskTable=document.getElementById("task-table"),calendarTable=document.getElementById("calendar-table"),calendarMonth=document.getElementById("calendar-month"),calendarPrev=document.getElementById("calendar-prev"),calendarNext=document.getElementById("calendar-next");export function showLoader(){pageLoader&&pageLoader.classList.add("visible")}export function hideLoader(){pageLoader&&pageLoader.classList.remove("visible")}hideLoader();const sunIcon='<svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>',moonIcon='<svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>',applyTheme=()=>{const e=localStorage.getItem("theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches,n="light"===e||!e&&!t;document.documentElement.classList.toggle("light",n),themeToggle&&(themeToggle.setAttribute("aria-pressed",n?"true":"false"),themeToggle.innerHTML=n?sunIcon:moonIcon)},updateToggle=()=>{sidebar.classList.contains("open")?(toggle.setAttribute("aria-label","Close navigation"),toggle.setAttribute("aria-expanded","true"),overlay.classList.add("visible"),localStorage.setItem("sidebarOpen","true"),!initialLoad&&firstLink&&firstLink.focus()):(toggle.setAttribute("aria-label","Open navigation"),toggle.setAttribute("aria-expanded","false"),overlay.classList.remove("visible"),localStorage.setItem("sidebarOpen","false"),initialLoad||toggle.focus()),initialLoad=!1};toggle.addEventListener("click",(()=>{sidebar.classList.toggle("open"),updateToggle()})),closeBtn&&closeBtn.addEventListener("click",(()=>{sidebar.classList.remove("open"),updateToggle()})),"true"===localStorage.getItem("sidebarOpen")&&sidebar.classList.add("open"),updateToggle(),document.addEventListener("keydown",(e=>{"Escape"===e.key&&sidebar.classList.contains("open")&&(sidebar.classList.remove("open"),updateToggle())})),overlay.addEventListener("click",(()=>{sidebar.classList.remove("open"),updateToggle()}));const showToast=e=>{toast&&(toast.textContent=e,toast.classList.add("show"),setTimeout((()=>toast.classList.remove("show")),2e3))},fetchUsers=()=>new Promise((e=>setTimeout(e,1e3)));function initTable(){if(!userTable)return;const e=userTable.querySelector("tbody");let t=Array.from(e.querySelectorAll("tr"));const n=initPagination(userTable),a=()=>{t=Array.from(e.querySelectorAll("tr")),n.update()},o=filterInput&&filterInput.dataset.columns?filterInput.dataset.columns.split(",").map(Number):null,l={},s=userTable.querySelectorAll("th.sortable");s.forEach(((a,o)=>{a.addEventListener("click",(()=>{const d=!l[o];l[o]=d,t.sort(((e,t)=>{const n=e.children[o].textContent.trim(),a=t.children[o].textContent.trim();return d?n.localeCompare(a):a.localeCompare(n)})),e.append(...t),s.forEach((e=>e.removeAttribute("aria-sort"))),a.setAttribute("aria-sort",d?"ascending":"descending"),n.update()}))})),filterInput&&filterInput.addEventListener("input",debounce((()=>{filterTableRows(t,filterInput.value,o),n.update()}),200));const d=e=>{const t=e.querySelector(".edit-user-btn"),n=e.querySelector(".delete-user-btn"),o=()=>{const a=e.children[0].textContent.trim();t&&t.setAttribute("aria-label",`Edit ${a}`),n&&n.setAttribute("aria-label",`Delete ${a}`)};o(),t&&t.addEventListener("click",(()=>{const t=e.children[0].textContent.trim(),n=e.querySelector("td:nth-child(2) .label").textContent.trim();openModal(`<form id="edit-user-form"><h3 id="edit-user-title">Edit User</h3><label>Username<input id="edit-username" type="text" value="${t}" required /></label><label>Status<select id="edit-status"><option value="Active"${"Active"===n?" selected":""}>Active</option><option value="Suspended"${"Suspended"===n?" selected":""}>Suspended</option></select></label><div class="modal-actions"><button type="submit" class="btn">Save</button><button type="button" class="btn" id="cancel-edit">Cancel</button></div></form>`,"edit-user-title");const a=document.getElementById("edit-user-form"),l=document.getElementById("cancel-edit");a.addEventListener("submit",(t=>{t.preventDefault(),e.children[0].textContent=document.getElementById("edit-username").value,o();const n=document.getElementById("edit-status").value,a=e.querySelector("td:nth-child(2) .label");a.textContent=n,a.classList.toggle("success","Active"===n),a.classList.toggle("danger","Active"!==n),closeModal()})),l.addEventListener("click",closeModal)})),n&&n.addEventListener("click",(()=>{e.remove(),a()}))};t.forEach(d),n.update(),addUserBtn&&addUserBtn.addEventListener("click",(()=>{openModal('<form id="add-user-form"><h3 id="add-user-title">Add User</h3><label>Username<input id="new-username" type="text" required /></label><label>Status<select id="new-status"><option value="Active">Active</option><option value="Suspended">Suspended</option></select></label><div class="modal-actions"><button type="submit" class="btn">Add</button><button type="button" class="btn" id="cancel-add">Cancel</button></div></form>',"add-user-title");const t=document.getElementById("add-user-form"),n=document.getElementById("cancel-add");t.addEventListener("submit",(t=>{t.preventDefault();const n=document.getElementById("new-username").value,o=document.getElementById("new-status").value,l=document.createElement("tr");l.innerHTML=`<td>${n}</td><td><span class="label ${"Active"===o?"success":"danger"}">${o}</span></td><td><button class="btn edit-user-btn" aria-label="Edit ${n}">Edit</button> <button class="btn delete-user-btn" aria-label="Delete ${n}">Delete</button></td>`,e.appendChild(l),d(l),a(),closeModal()})),n.addEventListener("click",closeModal)}))}function initTasks(){if(!taskTable)return;const e=taskTable.querySelector("tbody"),t=initPagination(taskTable),n=e=>{const n=e.querySelector(".edit-task-btn");n&&n.addEventListener("click",(()=>{const t=e.children[0].textContent.trim();openModal(`<form id="edit-task-form"><h3 id="edit-task-title">Edit Task</h3><input id="edit-task-input" type="text" value="${t}" required /><div class="modal-actions"><button type="submit" class="btn">Save</button><button type="button" class="btn" id="cancel-edit-task">Cancel</button></div></form>`,"edit-task-title");const n=document.getElementById("edit-task-form"),a=document.getElementById("cancel-edit-task");n.addEventListener("submit",(t=>{t.preventDefault(),e.children[0].textContent=document.getElementById("edit-task-input").value,closeModal()})),a.addEventListener("click",closeModal)}));const a=e.querySelector(".delete-task-btn");a&&a.addEventListener("click",(()=>{e.remove(),t.update()}))};Array.from(e.querySelectorAll("tr")).forEach(n),t.update(),taskForm&&taskForm.addEventListener("submit",(a=>{a.preventDefault();const o=taskInput.value.trim();if(!o)return;const l=document.createElement("tr");l.innerHTML=`<td>${o}</td><td><button class="btn edit-task-btn">Edit</button> <button class="btn delete-task-btn">Delete</button></td>`,e.appendChild(l),n(l),t.update(),taskForm.reset()}))}function initCalendar(){if(!calendarTable)return;let e=new Date;const t=calendarTable.querySelector("tbody"),n=()=>{const n=e.getFullYear(),a=e.getMonth();calendarMonth.textContent=e.toLocaleDateString(void 0,{month:"long",year:"numeric"});const o=new Date(n,a,1).getDay(),l=new Date(n,a+1,0).getDate();let s="<tr>";for(let e=0;e<o;e++)s+="<td></td>";for(let e=1;e<=l;e++)(o+e-1)%7==0&&1!==e&&(s+="</tr><tr>"),s+=`<td>${e}</td>`;s+="</tr>",t.innerHTML=s};calendarPrev&&calendarPrev.addEventListener("click",(()=>{e.setMonth(e.getMonth()-1),n()})),calendarNext&&calendarNext.addEventListener("click",(()=>{e.setMonth(e.getMonth()+1),n()})),n()}sidebar.querySelectorAll("a").forEach((e=>{e.addEventListener("click",(()=>{sidebar.classList.remove("open"),updateToggle(),showLoader()}))})),themeToggle&&themeToggle.addEventListener("click",(()=>{const e=!document.documentElement.classList.contains("light");document.documentElement.classList.toggle("light",e),themeToggle.setAttribute("aria-pressed",e?"true":"false"),themeToggle.innerHTML=e?sunIcon:moonIcon,localStorage.setItem("theme",e?"light":"dark")})),tableSkeleton&&userTable&&fetchUsers().then((()=>{tableSkeleton.remove(),userTable.hidden=!1,initTable()})),taskTable&&initTasks(),calendarTable&&initCalendar(),form&&form.addEventListener("submit",(e=>{e.preventDefault(),showToast("Settings saved")})),profileForm&&profileForm.addEventListener("submit",(e=>{e.preventDefault();openModal('<h3 id="profile-dialog-title">Save Changes</h3><p>Save profile changes?</p><div class="modal-actions"><button id="confirm-profile" class="btn">Yes</button><button id="cancel-profile" class="btn">Cancel</button></div>',"profile-dialog-title");const t=document.getElementById("confirm-profile"),n=document.getElementById("cancel-profile");t.addEventListener("click",(()=>{closeModal(),showToast("Profile updated")})),n.addEventListener("click",closeModal)})),initReportChart(chartCanvas,document.getElementById("report-range"));const visitorsCanvas=document.getElementById("visitorsChart"),sourceCanvas=document.getElementById("sourceChart"),startInput=document.getElementById("start-date"),endInput=document.getElementById("end-date"),applyBtn=document.getElementById("apply-range");initAnalyticsCharts(visitorsCanvas,sourceCanvas),applyBtn&&applyBtn.addEventListener("click",(()=>updateAnalyticsCharts(startInput,endInput))),applyTheme();const notifBadge=document.getElementById("notification-badge");function fetchNotifications(){return new Promise((e=>{setTimeout((()=>{e(["Server restarted","New user","Backup complete"])}),500)}))}function updateNotificationBadge(){notifBadge&&fetchNotifications().then((e=>{notifBadge.textContent=e.length,notifBadge.style.display=e.length?"inline-block":"none"}))}updateNotificationBadge(),"serviceWorker"in navigator&&window.addEventListener("load",(()=>{navigator.serviceWorker.register("service-worker.js")}));
